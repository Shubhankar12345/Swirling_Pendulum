from cmath import pi
import csv
import odrive
import numpy as np
from odrive.enums import *
import datetime
import time
import math
import numpy as np
from matplotlib import pyplot as plt
my_drive = odrive.find_any()
motor = my_drive.axis0.motor
axis = my_drive.axis0
ctrl = axis.controller
print("Starting closed loop control...")
my_drive.axis0.requested_state = AXIS_STATE_CLOSED_LOOP_CONTROL
print("Starting torque control...")
my_drive.axis0.controller.config.control_mode = CONTROL_MODE_TORQUE_CONTROL
torque_input_UL = 8
torque_input_LL  = -8
m1 = 0.465
m2 = 0.086
l1 = 0.13
l2 = 0.145
g = 9.81
l1_sqr = round(math.pow(l1,2),3) # l1^2 rounded to 3 decimal places
l2_sqr = round(math.pow(l2,2),3) # l2^2 rounded to 3 decimal places
m1l1_sqr = round(m1*l1_sqr,3) # m1*l1^2 product rounded to 3 decimal places
m2l2_sqr = round(m2*l2_sqr,3) # m2*l2^2 product rounded to 3 decimal places
four_by_3 = round(4/3,3) # Round 4/3 to three decimal places
m2l1l2 = round(m2*l1*l2,3) # Round m2*l1*l2 product to 3 decimal places
m2l1_sqr = round(m2*l1_sqr,3) #Round m2*l1^2 product to 3 decimal places
m1plustwom2sum = round((m1+2*m2)*g*l1,3) #Round (m1+2*m2)*g*l1 to 3 decimal places
m2gl2product = round(m2*g*l2,3) #Round m2*g*l2 to 3 decimal places
duration = 40
#estimate = t3[0]
# e_est = 0.1
# q = 0.00001
# # est = 1 #initial estimate of velocity
# P = 0.5
# Q = math.exp(-6)
# R = 0.8
# vel_est = 0.25 #Initial estimate of phi velocity
# vel_est1 = 0.01 #Initial estimate of theta velocity
phivel_previous = 0
thetavel_previous = 0
phi_current = round(my_drive.axis0.encoder.pos_estimate*2*math.pi,3) # initial phi angle in radians
phi_previous = phi_current #To store previous value of phi to help in velocity estimation
theta_current = round(my_drive.axis1.encoder.pos_estimate*2*math.pi,3) # initial theta angle in radians
theta_previous = theta_current #To store previous value of theta to help in velocity estimation
w = 3.14 #Frequency of sine wave
amp = 1
#Kalman Filter parameters
P1 = 0.001
P2 = P1
R = 0.0001 
q1 = 0.005
q2 = q1
theta_actual = []
phi_actual = []
theta_desired = []
timerx = []
theta_vel = []
phi_vel = []
control_ip = []
theta_vel_desired = []
phivel_filtered_output = 0
phivel_mea_previous = 0
phivel_filtered_output_previous = 0
thetavel_filtered_output = 0
thetavel_mea_previous = 0
phivel_est = 0
thetavel_est = amp*w
thetavel_filtered_output_previous = 0

M = np.empty((2,2),dtype='float') #dynamics D term
C = np.empty((2,2),dtype='float') #dynamics C term
G = np.empty((2,1),dtype='float') #dynamics G term
U = [] #feedback input
t_start = my_drive.system_stats.uptime # start time of trial
my_drive.axis0.encoder.set_linear_count(0)
my_drive.axis1.encoder.set_linear_count(0)
# Kp = 1200
# Kd = 120
while(True):
    time_x = (my_drive.system_stats.uptime-t_start)/1000 # current time in seconds
    if(time_x > duration):
        break
    sphi = round(math.sin(phi_current),3) #Sine of phi in upto 3 decimal places
    cphi = round(math.cos(phi_current), 3) #Cosine of phi upto 3 decimal places
    s2phi = round(math.pow(sphi,2),3) #square of sin(phi) upto 3 decimal places
    c2phi = round(math.pow(cphi,2),3) #square of cos(phi) upto 3 decimal places
    stheta = round(math.sin(theta_current),3) #Sine of theta upto 3 decimal places
    ctheta = round(math.cos(theta_current),3) #Cosine of theta upto 3 decimal places

    if(time_x < 10):
        Kp = 1000
        Kd = 70
        theta_setpoint = round(math.sin(w*time_x),3)
        u = -math.pow(w,2.0)*theta_setpoint
    elif(time_x >= 10 and time_x < 20):  
        Kp = 1200
        Kd = 50
        t1 = time_x - 10
        theta_setpoint = 0.1*t1
        u = 0 
    elif(time_x >= 20 and time_x < 30):
        Kp = 1200
        Kd = 100
        theta_setpoint = 1
        u = 0
    else:
        Kp = 1200
        Kd = 50
        t2 = time_x - 30
        theta_setpoint = -0.1*t2 + 1
        u = 0     
    # set point Sine wave
    # theta_setpoint = amp*round(math.sin(w*time_x),3)
    # # Square wave

    # phi_square = math.ceil(round(math.sin(w*time_x),3))

    # if phi_square == -1:
    #     phi_square = 0
    # phi_setpoint = phi_square
    # theta_setpoint = 0.1*time_x
    theta_error = theta_setpoint - theta_current
    u = u + (Kp*theta_error - Kd*thetavel_est) #command for ddottheta to follow
    M[0][0]= four_by_3*(m1l1_sqr+3*m2l1_sqr+m2l2_sqr*s2phi)
    M[0][1] = 2*m2l1l2*cphi
    M[1][0] = 2*m2l1l2*cphi
    M[1][1] = four_by_3*m2l2_sqr
    C[0][0] = four_by_3*m2l2_sqr*sphi*cphi*phivel_est
    C[0][1] = four_by_3*m2l2_sqr*sphi*cphi*thetavel_est - 2*m2l1l2*sphi*phivel_est
    C[1][0] = -four_by_3*m2l2_sqr*cphi*sphi*thetavel_est
    C[1][1] = 0
    G[0][0] = m1plustwom2sum*stheta + m2gl2product*sphi*ctheta
    G[1][0] = m2gl2product*stheta*cphi
    # if(M_01 == 0):
    #     M_01_i = 0
    # else:
    #     M_01_i = 1/M_01
    M_i = np.linalg.pinv(M)
# Non collocated torque
    t1 = G[1][0] - M_i[0][1]*M[1][1]*G[0][0]
    t2 = M[1][0] - M[1][1]*M_i[1][0]*M[0][0]
    t3 = C[1][0] - M[1][1]*M_i[0][1]*C[0][0]
    t4 = C[1][1] - M[1][1]*M_i[0][1]*C[0][1]
    torque = 0.8*(t1 + t2*u + t3*thetavel_est + t4*phivel_est) # PFL computed torque
    print(my_drive.axis0.motor.current_control.Iq_measured)
    if(torque > torque_input_UL): #saturation limit
        torque = torque_input_UL
    if(torque < torque_input_LL):
        torque = torque_input_LL 
    my_drive.axis0.controller.input_torque = -torque
    phi_current = round(my_drive.axis0.encoder.pos_estimate*2*math.pi,3)
    theta_current = round(my_drive.axis1.encoder.pos_estimate*2*math.pi,3)
    thetavel_previous = round(my_drive.axis1.encoder.vel_estimate*2*math.pi,3)
    phivel_previous = round(my_drive.axis0.encoder.vel_estimate*2*math.pi,3)
    # dt = (my_drive.system_stats.uptime - )/1000
    # if(dt == 0): # If change in time is 0 then the velocities should be same as previous
    #     thetavel_mea = thetavel_previous
    #     phivel_mea = phi_previous
    #     # phivel_mea_previous = phivel_mea
    #     # thetavel_mea_previous = thetavel_mea
    # else:
    #     thetavel_mea = round(((theta_current-theta_previous)/dt),3) # Insantaneous Theta velocity estimation
    #     phivel_mea = (phi_current - phi_previous)/dt # Instantaneous Phi Velocity estimation
    #     vel_filtered_output = 0.9359*phivel_filtered_output_previous + 0.064*phivel_mea_previous
    #     thetavel_filtered_output = 0.9359*thetavel_filtered_output_previous + 0.064*thetavel_mea_previous
    # print("phi velocity = ",phivel_mea)
    # previous_estimate = vel_est
    # P = P + Q
    # KG = P/(P+R)
    # vel_est = vel_est + KG*(vel_filtered_output - vel_est)
    # P = (1-KG)*P + q*abs(previous_estimate - vel_est)
    # phivel_previous = phivel_mea
    # previous_estimate1 = vel_est1
    # P = P + Q
    # KG_theta = P/(P+R)
    # vel_est1 = vel_est1 + KG_theta*(thetavel_mea - vel_est1)
    # P = (1-KG_theta)*P + q*abs(previous_estimate1-vel_est1)
    # thetavel_previous = thetavel_mea
    # phi_previous = phi_current
    # theta_previous = theta_current
    # thetavel_mea_previous = thetavel_filtered_output
    # thetavel_filtered_output_previous = thetavel_filtered_output
    # phivel_mea_previous = phivel_mea
    # phivel_filtered_output_previous = vel_filtered_output

    # Kalman smoothing of velocity
    vel_est1 = phivel_est
    KG_phi = P1/(P1+R)
    phivel_est = phivel_est + KG_phi*(phivel_previous - phivel_est)
    P1 = (1-KG_phi)*P1 + q1*abs(vel_est1-phivel_est)    

    vel_est2 = thetavel_est
    KG_theta = P2/(P2+R)
    thetavel_est = thetavel_est + KG_theta*(thetavel_previous - thetavel_est)
    P2 = (1-KG_theta)*P2 + q2*abs(vel_est2-thetavel_est)      
    timerx.append(time_x)
    U.append(u)
    theta_actual.append(theta_current)
    theta_vel.append(thetavel_est)
    phi_actual.append(phi_current)
    phi_vel.append(phivel_est)
    control_ip.append(torque)
    theta_desired.append(theta_setpoint)
    # theta_vel_desired.append(math.cos(w*time_x)*amp*w)
    theta_vel_desired.append(0.1)    
my_drive.axis0.controller.input_torque = 0 #To stop the motor at the end of the trial
my_drive.axis0.requested_state = AXIS_STATE_IDLE #to put the motor in idle state at the end of rotation
fig0 = plt.figure()
plt.plot(timerx,theta_desired,label='desired')
plt.plot(timerx,theta_actual,label='actual')
plt.xlabel("Time in seconds")
plt.ylabel("theta in radians")
plt.legend()
fig1 = plt.figure()
plt.plot(timerx,theta_vel_desired,label='desired')
plt.plot(timerx,theta_vel,label='actual')
plt.xlabel("Time in seconds")
plt.ylabel("Angular velocity in radians per second")
plt.legend()
fig2 = plt.figure()
plt.plot(timerx,control_ip,label='control ip')
plt.xlabel("Time in seconds")
plt.ylabel("Torque in Nm")
plt.legend()
fig3 = plt.figure()
plt.plot(timerx,U,label='feedback ip')
plt.xlabel("Time in seconds")
plt.ylabel("input")
plt.legend()
# fig4 = plt.figure()
# plt.plot(timerx,D,label='inertia term')
# plt.xlabel("Time in seconds")
# plt.ylabel("inertia tem in kg m^2")
# plt.legend()
# fig5 = plt.figure()
# plt.plot(timerx,C,label='coriolis and centripetal')
# plt.xlabel("Time in seconds")
# plt.ylabel("coriolis terms")
# plt.legend()
# fig6 = plt.figure()
# plt.plot(timerx,G,label='gravity')
# plt.xlabel("Time in seconds")
# plt.ylabel("gravity term")
# plt.legend()
# fig7 = plt.figure()
# plt.plot(timerx,phi_vel,label='angular velocity phi')
# plt.xlabel("Time in seconds")
# plt.ylabel("angular velocity in radians per second")
# plt.legend()
plt.show()
x = str(datetime.datetime.now())
x = x.replace(":","-")
y = ('Swirling pendulum partial feedback linearisation noncollocated -{}.csv').format(x)
with open(y, 'w', newline='') as f: # Storing the data in CSV format
    thewriter = csv.writer(f)
    thewriter.writerow(['time','theta_desired','phi_actual','theta_actual', 'dottheta', 'dotphi', 'Torque'])
    for i in range(0, len(timerx)):
        thewriter.writerow([timerx[i],theta_desired[i],phi_actual[i],theta_actual[i],theta_vel[i],phi_vel[i],control_ip[i],])
quit()
    












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































