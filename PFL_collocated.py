from cmath import pi
import csv
import odrive
import numpy as np
from odrive.enums import *
import datetime
import time
import math
import numpy as np
from matplotlib import pyplot as plt
my_drive = odrive.find_any()
motor = my_drive.axis0.motor
axis = my_drive.axis0
ctrl = axis.controller
print("Starting closed loop control...")
my_drive.axis0.requested_state = AXIS_STATE_CLOSED_LOOP_CONTROL
print("Starting torque control...")
my_drive.axis0.controller.config.control_mode = CONTROL_MODE_TORQUE_CONTROL
torque_input_UL = 3
torque_input_LL  = -3
# Kp = 5  
# Kd = 0
m1 = 0.465
m2 = 0.086
# m2 = 0.209
l1 = 0.1
l1_sqr = round(math.pow(l1,2),3) # l1^2 rounded to 3 decimal places
l2 = 0.13
g = 9.81
l2_sqr = round(math.pow(l2,2),3) # l2^2 rounded to 3 decimal places
m1l1_sqr = round(m1*l1_sqr,3) # m1*l1^2 product rounded to 3 decimal places
m2l2_sqr = round(m2*l2_sqr,3) # m2*l2^2 product rounded to 3 decimal places
four_by_3 = round(4/3,3) # Round 4/3 to three decimal places
m2l1l2 = round(m2*l1*l2,3) # Round m2*l1*l2 product to 3 decimal places
m2l1_sqr = round(m2*l1_sqr,3) #Round m2*l1^2 product to 3 decimal places
m1plustwom2sum = round((m1+2*m2)*g*l1,3) #Round (m1+2*m2)*g*l1 to 3 decimal places
m2gl2product = round(m2*g*l2,3) #Round m2*g*l2 to 3 decimal places
duration = 40
# estimate = t3[0]
# e_est = 0.1
# q = 0.00001
# est = 1 #initial estimate of velocity
# P = 0.5
# Q = math.exp(-6)
# R = 0.8
# vel_est = 0.25 #Initial estimate of phi velocity
# vel_est1 = 0.01 #Initial estimate of theta velocity
phivel_previous = 0
thetavel_previous = 0
phi_current = round(my_drive.axis0.encoder.pos_estimate*2*math.pi,3) # initial phi angle in radians
phi_previous = phi_current #To store previous value of phi to help in velocity estimation
theta_current = round(my_drive.axis1.encoder.pos_estimate*2*math.pi,3) # initial theta angle in radians
theta_previous = theta_current #To store previous value of theta to help in velocity estimation
w = round(math.pi,3) #Frequency of sine wave
theta_actual = []
phi_actual = []
phi_desired = []
timerx = []
theta_vel = []
phi_vel = []
control_ip = []
phi_vel_desired = []
Iqsp = [] 
Id = [] 
phivel_filtered_output = 0
phivel_mea_previous = 0
phivel_filtered_output_previous = 0
thetavel_filtered_output = 0
thetavel_mea_previous = 0
thetavel_filtered_output_previous = 0
t_start = my_drive.system_stats.uptime # start time of trial
t_prev = 0
my_drive.axis0.encoder.set_linear_count(0)
my_drive.axis1.encoder.set_linear_count(0)
while(True):
    time_x = (my_drive.system_stats.uptime - t_start)/1000 # current time in seconds
    # tdiff = (time_x*1000) - t_prev
    if(time_x > duration):
        break
    sphi = math.sin(phi_current) #Sine of phi in upto 3 decimal places
    cphi = math.cos(phi_current) #Cosine of phi upto 3 decimal places
    s2phi = math.pow(sphi,2) #square of sin(phi) upto 3 decimal places
    c2phi = math.pow(cphi,2) #square of cos(phi) upto 3 decimal places
    stheta = math.sin(phi_current) #Sine of theta upto 3 decimal places
    ctheta = math.cos(theta_current) #Cosine of theta upto 3 decimal places
    if(time_x < 10):
        Kp = 12000
        Kd = 500
        phi_setpoint = round(math.sin(w*time_x),3)
        u = -math.pow(w,2.0)*phi_setpoint
    elif(time_x >= 10 and time_x < 20):
        Kp = 8000
        Kd = 500       
        t1 = time_x - 10
        phi_setpoint = 0.1*t1
        u = 0 
    elif(time_x >= 20 and time_x < 30):
        Kp = 8000
        Kd = 500
        phi_setpoint = 1
        u = 0
    else:
        Kp = 8000
        Kd = 500
        t2 = time_x - 30
        phi_setpoint = -0.1*t2 + 1
        u = 0 
    # # Square wave
    # phi_square = math.ceil(round(math.sin(w*time_x),3))
    # if phi_square == -1:
    #     phi_square = 0
    # phi_setpoint = phi_square*0.5
    phi_error = phi_setpoint - phi_current
    u = (u + Kp*phi_error - Kd*phivel_previous) #command for ddotphi to follow
    M_00= four_by_3*(m1l1_sqr+3*m2l1_sqr+m2l2_sqr*s2phi)
    M_01 = 2*m2l1l2*cphi
    M_10 = 2*m2l1l2*cphi
    M_11 = four_by_3*m2l2_sqr
    C_00 = four_by_3*m2l2_sqr*sphi*cphi*phivel_previous
    C_01 = four_by_3*m2l2_sqr*sphi*cphi*thetavel_previous - 2*m2l1l2*sphi*phivel_previous
    C_10 = -four_by_3*m2l2_sqr*cphi*sphi*thetavel_previous
    C_11 = 0
    G_00 = m1plustwom2sum*stheta + m2gl2product*sphi*ctheta
    G_10 = m2gl2product*stheta*cphi
    d22_p = M_11 - (M_01*M_10)/M_00
    h1 = C_00*thetavel_previous + C_01*phivel_previous
    h2 = C_10*thetavel_previous + C_11*phivel_previous
    c2_p = h2 - (M_10*h1)/M_00
    g2_p = G_10 - (M_10*G_00)/M_00
    torque = (d22_p*u + c2_p + g2_p) # PFL computed torque
    # print(torque)
    if(torque > torque_input_UL): #saturation limit
        torque = torque_input_UL
    if(torque < torque_input_LL):
        torque = torque_input_LL 
    my_drive.axis0.controller.input_torque = torque
    phi_current = round(my_drive.axis0.encoder.pos_estimate*2*math.pi,3)
    theta_current = round(my_drive.axis1.encoder.pos_estimate*2*math.pi,3)
    thetavel_previous = round(my_drive.axis1.encoder.vel_estimate*2*math.pi,3)
    phivel_previous = round(my_drive.axis0.encoder.vel_estimate*2*math.pi,3)
    # dt = (my_drive.system_stats.uptime - time_x*1000)/1000
    # if(dt == 0): # If change in time is 0 then the velocities should be same as previous
    #     thetavel_mea = thetavel_previous
    #     phivel_mea = phi_previous
    #     phivel_mea_previous = phivel_mea
    #     thetavel_mea_previous = thetavel_mea
    # else:
    #     thetavel_mea = round(((theta_current-theta_previous)/dt),3) # Insantaneous Theta velocity estimation
    #     phivel_mea = (phi_current - phi_previous)/dt # Instantaneous Phi Velocity estimation
        # vel_filtered_output = 0.9359*phivel_filtered_output_previous + 0.064*phivel_mea_previous
        # thetavel_filtered_output = 0.9359*thetavel_filtered_output_previous + 0.064*thetavel_mea_previous
    # print("phi velocity = ",phivel_mea)
    # previous_estimate = vel_est
    # P = P + Q
    # KG = P/(P+R)
    # vel_est = vel_est + KG*(vel_filtered_output - vel_est)
    # P = (1-KG)*P + q*abs(previous_estimate - vel_est)
    # phivel_previous = phivel_mea
    # previous_estimate1 = vel_est1
    # P = P + Q
    # KG_theta = P/(P+R)
    # vel_est1 = vel_est1 + KG_theta*(thetavel_mea - vel_est1)
    # P = (1-KG_theta)*P + q*abs(previous_estimate1-vel_est1)
    # thetavel_previous = thetavel_mea
    # phi_previous = phi_current
    # theta_previous = theta_current
    # thetavel_mea_previous = thetavel_filtered_output
    # thetavel_filtered_output_previous = thetavel_filtered_output
    # phivel_previous = phivel_mea
    # phivel_filtered_output_previous = vel_filtered_output
    timerx.append(time_x)
    theta_actual.append(theta_current)
    theta_vel.append(thetavel_previous)
    phi_actual.append(phi_current)
    phi_vel.append(phivel_previous)
    control_ip.append(torque)
    Iqsp.append(my_drive.axis0.motor.current_control.Iq_setpoint)
    Id.append(my_drive.axis0.motor.current_control.Iq_measured)
    phi_desired.append(phi_setpoint)
        # t_prev = time_x*1000
    # phi_vel_desired.append(math.cos(w*time_x)*0.5*w)
my_drive.axis0.controller.input_torque = 0 #To stop the motor at the end of the trial
my_drive.axis0.requested_state = AXIS_STATE_IDLE #to put the motor in idle state at the end of rotation
print("Putting Odrive in Idle mode")
fig = plt.figure()
plt.plot(timerx,phi_desired,label='desired')
plt.plot(timerx,phi_actual,label='actual')
plt.xlabel("Time in seconds")
plt.ylabel("phi in radians")
plt.legend()
# plt.show()
fig1 = plt.figure()
# plt.plot(timerx,phi_vel_desired,label='desired')
plt.plot(timerx,phi_vel,label='actual')
plt.xlabel("Time in seconds")
plt.ylabel("Angular velocity in radians per second")
plt.legend()
fig2 = plt.figure()
plt.plot(timerx,Iqsp,label='desired current')
plt.plot(timerx,Id,label='actual current')
plt.xlabel("Time in seconds")
plt.ylabel("Current in A")
plt.legend()
fig3 = plt.figure()
plt.plot(timerx,control_ip,label='control ip')
plt.xlabel("Time in seconds")
plt.ylabel("Torque in Nm")
plt.legend()
plt.show()
# x = str(datetime.datetime.now())
# x = x.replace(":","-")
# y = ('Swirling pendulum partial feedback linearisation -{}.csv').format(x)
# with open(y, 'w', newline='') as f: # Storing the data in CSV format
#     thewriter = csv.writer(f)
#     thewriter.writerow(['time','phi_desired','phi_actual','phivel_actual','theta_actual', 'thetavel','Torque', 'kp', 'kd'])
#     for i in range(0, len(timerx)):
#         thewriter.writerow([timerx[i],phi_desired[i],phi_actual[i],phi_vel[i],theta_actual[i],theta_vel[i],control_ip[i],Kp,Kd])
quit()
    












































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































































